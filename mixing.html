<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mixing Scale-Up Helper</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <style>
      :root {
        --ink: #1a1a1a;
        --ink-muted: #4a4a4a;
        --paper: #f6f3ee;
        --accent: #c06b3e;
        --accent-2: #2e6a8a;
        --panel: #fffaf3;
        --panel-2: #f0f6f8;
        --shadow: rgba(0, 0, 0, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        background:
          radial-gradient(1200px 800px at 10% 10%, #f9efe3 0%, transparent 60%),
          radial-gradient(900px 700px at 90% 20%, #e8f1f6 0%, transparent 55%),
          linear-gradient(160deg, #f7f1e8 0%, #f1efe7 45%, #eef2f1 100%);
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
      }

      header {
        padding: 36px 18px 20px;
        text-align: center;
      }

      header h1 {
        margin: 0;
        font-family: "Georgia", "Palatino Linotype", "Book Antiqua", serif;
        font-size: clamp(28px, 3.5vw, 44px);
        letter-spacing: 0.5px;
      }

      header p {
        margin: 10px auto 0;
        max-width: 720px;
        color: var(--ink-muted);
        font-size: clamp(14px, 1.6vw, 18px);
      }

      main {
        max-width: 1100px;
        margin: 0 auto 56px;
        padding: 0 18px;
        display: grid;
        gap: 22px;
      }

      .panel {
        background: var(--panel);
        border-radius: 18px;
        box-shadow: 0 14px 30px var(--shadow);
        padding: 20px;
        animation: rise 0.8s ease both;
      }

      .panel:nth-of-type(2) {
        background: var(--panel-2);
        animation-delay: 0.08s;
      }

      .panel h2 {
        margin: 0 0 12px;
        font-size: 20px;
        letter-spacing: 0.2px;
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        align-items: start;
      }

      .row-block {
        display: grid;
        gap: 10px;
      }

      .row-block + .row-block {
        margin-top: 12px;
      }

      .row-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent-2);
        font-weight: 700;
      }

      .row-grid {
        align-items: start;
      }

      .field {
        display: grid;
        gap: 6px;
      }

      .field.with-hint {
        position: relative;
        padding-bottom: 28px;
      }

      label {
        font-size: 13px;
        color: var(--ink-muted);
        min-height: 32px;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      label.inline {
        flex-wrap: nowrap;
      }

      label.inline .pill {
        margin-top: 0;
      }

      .help {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        margin-left: 6px;
        border-radius: 50%;
        border: 1px solid rgba(26, 26, 26, 0.25);
        font-size: 11px;
        color: var(--ink-muted);
        position: relative;
        cursor: help;
      }

      .help::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        bottom: 140%;
        transform: translateX(-50%);
        background: #1f2a2f;
        color: #f7f5f0;
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        line-height: 1.3;
        min-width: 180px;
        max-width: 240px;
        text-align: left;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .help::before {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 120%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: #1f2a2f transparent transparent transparent;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .help:hover::after,
      .help:hover::before {
        opacity: 1;
      }

      input {
        border: 1px solid #d4cfc6;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 15px;
        background: #fff;
        color: var(--ink);
        height: 42px;
      }

      input:focus {
        outline: 2px solid rgba(192, 107, 62, 0.35);
        border-color: var(--accent);
      }

      .results {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed rgba(0, 0, 0, 0.2);
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(46, 106, 138, 0.12);
        color: var(--accent-2);
        font-size: 12px;
        margin-top: 4px;
      }

      .hint {
        position: absolute;
        left: 0;
        bottom: 0;
        font-size: 12px;
        color: var(--ink-muted);
        max-width: 100%;
        line-height: 1.2;
      }

      .note {
        font-size: 12px;
        color: var(--ink-muted);
        margin-top: 6px;
      }

      .action-row {
        margin-top: 10px;
      }

      .ghost-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(46, 106, 138, 0.4);
        color: var(--accent-2);
        background: transparent;
        font-size: 13px;
        cursor: pointer;
      }

      .ghost-button.compact {
        padding: 6px 12px;
        font-size: 12px;
      }

      .tutorial-overlay {
        position: fixed;
        inset: 0;
        background: rgba(20, 24, 28, 0.45);
        display: flex;
        justify-content: flex-end;
        align-items: flex-start;
        padding: 24px;
        z-index: 1000;
      }

      .tutorial-overlay[hidden] {
        display: none;
      }

      .tutorial-card {
        width: min(520px, 92vw);
        background: #ffffff;
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        display: grid;
        gap: 10px;
        position: relative;
        z-index: 1002;
      }

      .tutorial-step {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent-2);
        font-weight: 700;
      }

      .tutorial-text {
        font-size: 15px;
        color: var(--ink);
        line-height: 1.45;
      }

      .tutorial-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .tutorial-button {
        border-radius: 999px;
        border: 1px solid rgba(46, 106, 138, 0.4);
        background: transparent;
        color: var(--accent-2);
        padding: 8px 14px;
        font-size: 13px;
        cursor: pointer;
      }

      .tutorial-button.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      .tutorial-target {
        outline: 3px solid rgba(46, 106, 138, 0.6);
        box-shadow: 0 0 0 6px rgba(46, 106, 138, 0.15);
        border-radius: 12px;
        position: relative;
        z-index: 1001;
        background-clip: padding-box;
        pointer-events: none;
      }

      footer {
        text-align: center;
        padding: 0 18px 24px;
        color: var(--ink-muted);
        font-size: 12px;
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(18px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 720px) {
        header {
          padding-top: 28px;
        }

        .tutorial-overlay {
          justify-content: center;
          align-items: flex-end;
          padding: 16px;
        }

        .tutorial-card {
          width: min(210px, 86vw);
          padding: 8px;
          gap: 8px;
        }

        .tutorial-text {
          font-size: 11px;
          line-height: 1.25;
        }

        .tutorial-actions {
          gap: 4px;
        }

        .tutorial-button {
          padding: 4px 8px;
          font-size: 10px;
        }

        .ghost-button.compact {
          padding: 5px 10px;
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Mixing Scale-Up Helper</h1>
      <p>
        Prototype for agitated-tank scale-up. Choose a rule (keep P/V or keep tip speed),
        enter lab data, and see plant-scale outputs.
      </p>
      <p>
        <a href="index.html">Back to home</a> | Need help selecting Np or impeller setup? See the
        <a href="np-guide.html">Impeller & Np guide</a>.
      </p>
      <div class="action-row">
        <button class="ghost-button" type="button" id="clear-values">Clear values</button>
        <button class="ghost-button" type="button" id="start-tutorial">Tutorial</button>
      </div>
    </header>

    <main>
      <section class="panel" id="keep-pv">
        <div class="panel-header">
          <h2>Keep P/V Constant</h2>
          <button class="ghost-button compact" type="button" id="copy-pv">Copy</button>
        </div>
        <div class="row-block">
          <div class="row-title">Fluid properties</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="pv-rho">Density rho (g/mL)</label>
              <input id="pv-rho" type="number" step="any" min="0" placeholder="e.g. 1 for water" />
            </div>
            <div class="field with-hint">
              <label for="pv-mu">
                Viscosity mu (Pa*s)
                <span class="help" data-tooltip="Dynamic viscosity of the fluid. Use Pa*s (1 mPa*s = 0.001 Pa*s). You can type a value or a fluid name.">?</span>
              </label>
              <input id="pv-mu" type="text" list="viscosity-list" placeholder="e.g. 0.001 for water or Acetone" />
              <div class="hint" id="pv-mu-hint"></div>
            </div>
          </div>
        </div>
        <div class="row-block">
          <div class="row-title">Lab inputs</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="pv-np-lab">
                Power number lab Np
                <span class="help" data-tooltip="Dimensionless power number for the lab impeller in the given flow regime.">?</span>
              </label>
              <input id="pv-np-lab" type="number" step="any" min="0" placeholder="e.g. 3.5" />
            </div>
            <div class="field">
              <label for="pv-d-lab">
                Impeller diameter lab D (mm)
                <span class="help" data-tooltip="Impeller diameter used in the lab tank.">?</span>
              </label>
              <input id="pv-d-lab" type="number" step="any" min="0" placeholder="e.g. 100" />
            </div>
            <div class="field">
              <label for="pv-rpm-lab">
                Agitator speed lab (rpm)
                <span class="help" data-tooltip="Lab impeller speed in revolutions per minute.">?</span>
              </label>
              <input id="pv-rpm-lab" type="number" step="any" min="0" placeholder="e.g. 300" />
            </div>
            <div class="field">
              <label for="pv-v-lab">
                Working volume lab (L)
                <span class="help" data-tooltip="Liquid working volume in the lab vessel.">?</span>
              </label>
              <input id="pv-v-lab" type="number" step="any" min="0" placeholder="e.g. 2" />
            </div>
          </div>
        </div>
        <div class="row-block">
          <div class="row-title">Plant inputs</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="pv-d-plant">
                Impeller diameter plant D (mm)
                <span class="help" data-tooltip="Impeller diameter for the plant-scale tank.">?</span>
              </label>
              <input id="pv-d-plant" type="number" step="any" min="0" placeholder="e.g. 1200" />
            </div>
            <div class="field">
              <label for="pv-v-plant">
                Working volume plant (L)
                <span class="help" data-tooltip="Liquid working volume at plant scale.">?</span>
              </label>
              <input id="pv-v-plant" type="number" step="any" min="0" placeholder="e.g. 1000" />
            </div>
            <div class="field">
              <label for="pv-np-plant">
                Power number plant Np
                <span class="help" data-tooltip="Power number for the plant impeller; can differ from lab if geometry differs.">?</span>
              </label>
              <input id="pv-np-plant" type="number" step="any" min="0" placeholder="e.g. 3.5" />
            </div>
          </div>
        </div>
        <div class="results">
          <div class="row-block">
            <div class="row-title">Lab results</div>
            <div class="grid row-grid">
              <div class="field">
                <label>
                  N lab (1/s)
                  <span class="help" data-tooltip="Impeller rotational speed in revolutions per second (rpm/60).">?</span>
                </label>
                <input id="pv-n-lab" readonly />
              </div>
              <div class="field">
                <label>Tip speed lab (m/s)</label>
                <input id="pv-ut-lab" readonly />
              </div>
              <div class="field">
                <label>Power lab (W)</label>
                <input id="pv-p-lab" readonly />
              </div>
              <div class="field">
                <label>P/V lab (W/m3)</label>
                <input id="pv-pv-lab" readonly />
              </div>
              <div class="field">
                <label class="inline">
                  Re lab
                  <span class="help" data-tooltip="Mixing Reynolds number = rho * N * D^2 / mu. Indicates flow regime.">?</span>
                  <span class="pill" id="pv-regime-lab">--</span>
                </label>
                <input id="pv-re-lab" readonly />
              </div>
            </div>
          </div>
          <div class="row-block">
            <div class="row-title">Plant results</div>
            <div class="grid row-grid">
              <div class="field">
                <label>Power plant (W)</label>
                <input id="pv-p-plant" readonly />
              </div>
              <div class="field">
                <label>
                  N plant (1/s)
                  <span class="help" data-tooltip="Impeller rotational speed in revolutions per second (rpm/60).">?</span>
                </label>
                <input id="pv-n-plant" readonly />
              </div>
              <div class="field">
                <label>rpm plant</label>
                <input id="pv-rpm-plant" readonly />
              </div>
              <div class="field">
                <label>Tip speed plant (m/s)</label>
                <input id="pv-ut-plant" readonly />
              </div>
              <div class="field">
                <label class="inline">
                  Re plant
                  <span class="help" data-tooltip="Mixing Reynolds number = rho * N * D^2 / mu. Indicates flow regime.">?</span>
                  <span class="pill" id="pv-regime-plant">--</span>
                </label>
                <input id="pv-re-plant" readonly />
              </div>
              <div class="field">
                <label>Torque plant (N*m)</label>
                <input id="pv-torque" readonly />
              </div>
              <div class="field">
                <label>P/V plant (W/m3)</label>
                <input id="pv-pv-plant" readonly />
              </div>
            </div>
          </div>
        </div>
        <div class="note">
          Use when energy input per volume should match lab behavior (e.g., mixing time or suspension scaling).
          P/V is power per unit volume, using P = Np * rho * N^3 * D^5.
        </div>
      </section>

      <section class="panel" id="keep-tip">
        <div class="panel-header">
          <h2>Keep Tip Speed Constant</h2>
          <button class="ghost-button compact" type="button" id="copy-tip">Copy</button>
        </div>
        <div class="row-block">
          <div class="row-title">Fluid properties</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="tip-rho">
                Density rho (g/mL)
                <span class="help" data-tooltip="Fluid density used for Reynolds and power calculations.">?</span>
              </label>
              <input id="tip-rho" type="number" step="any" min="0" placeholder="e.g. 1 for water" />
            </div>
            <div class="field with-hint">
              <label for="tip-mu">
                Viscosity mu (Pa*s)
                <span class="help" data-tooltip="Dynamic viscosity of the fluid. Use Pa*s (1 mPa*s = 0.001 Pa*s). You can type a value or a fluid name.">?</span>
              </label>
              <input id="tip-mu" type="text" list="viscosity-list" placeholder="e.g. 0.001 for water or Acetone" />
              <div class="hint" id="tip-mu-hint"></div>
            </div>
          </div>
        </div>
        <div class="row-block">
          <div class="row-title">Lab inputs</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="tip-d-lab">
                Impeller diameter lab D (mm)
                <span class="help" data-tooltip="Impeller diameter used in the lab tank.">?</span>
              </label>
              <input id="tip-d-lab" type="number" step="any" min="0" placeholder="e.g. 100" />
            </div>
            <div class="field">
              <label for="tip-rpm-lab">
                Agitator speed lab (rpm)
                <span class="help" data-tooltip="Lab impeller speed in revolutions per minute.">?</span>
              </label>
              <input id="tip-rpm-lab" type="number" step="any" min="0" placeholder="e.g. 300" />
            </div>
          </div>
        </div>
        <div class="row-block">
          <div class="row-title">Plant inputs</div>
          <div class="grid row-grid">
            <div class="field">
              <label for="tip-d-plant">
                Impeller diameter plant D (mm)
                <span class="help" data-tooltip="Impeller diameter for the plant-scale tank.">?</span>
              </label>
              <input id="tip-d-plant" type="number" step="any" min="0" placeholder="e.g. 1200" />
            </div>
            <div class="field">
              <label for="tip-v-plant">
                Working volume plant (L)
                <span class="help" data-tooltip="Liquid working volume at plant scale.">?</span>
              </label>
              <input id="tip-v-plant" type="number" step="any" min="0" placeholder="e.g. 1000" />
            </div>
            <div class="field">
              <label for="tip-np-plant">
                Power number plant Np
                <span class="help" data-tooltip="Power number for the plant impeller.">?</span>
              </label>
              <input id="tip-np-plant" type="number" step="any" min="0" placeholder="e.g. 3.5" />
            </div>
          </div>
        </div>
        <div class="results">
          <div class="row-block">
            <div class="row-title">Lab results</div>
            <div class="grid row-grid">
              <div class="field">
                <label>
                  N lab (1/s)
                  <span class="help" data-tooltip="Impeller rotational speed in revolutions per second (rpm/60).">?</span>
                </label>
                <input id="tip-n-lab" readonly />
              </div>
              <div class="field">
                <label>Tip speed target (m/s)</label>
                <input id="tip-ut-target" readonly />
              </div>
              <div class="field">
                <label class="inline">
                  Re lab
                  <span class="help" data-tooltip="Mixing Reynolds number = rho * N * D^2 / mu. Indicates flow regime.">?</span>
                  <span class="pill" id="tip-regime-lab">--</span>
                </label>
                <input id="tip-re-lab" readonly />
              </div>
            </div>
          </div>
          <div class="row-block">
            <div class="row-title">Plant results</div>
            <div class="grid row-grid">
              <div class="field">
                <label>
                  N plant (1/s)
                  <span class="help" data-tooltip="Impeller rotational speed in revolutions per second (rpm/60).">?</span>
                </label>
                <input id="tip-n-plant" readonly />
              </div>
              <div class="field">
                <label>rpm plant</label>
                <input id="tip-rpm-plant" readonly />
              </div>
              <div class="field">
                <label>Power plant (W)</label>
                <input id="tip-p-plant" readonly />
              </div>
              <div class="field">
                <label>P/V plant (W/m3)</label>
                <input id="tip-pv-plant" readonly />
              </div>
              <div class="field">
                <label class="inline">
                  Re plant
                  <span class="help" data-tooltip="Mixing Reynolds number = rho * N * D^2 / mu. Indicates flow regime.">?</span>
                  <span class="pill" id="tip-regime-plant">--</span>
                </label>
                <input id="tip-re-plant" readonly />
              </div>
              <div class="field">
                <label>Torque plant (N*m)</label>
                <input id="tip-torque" readonly />
              </div>
            </div>
          </div>
        </div>
        <div class="note">
          Use when shear or gas dispersion is tied to tip speed. Keeps U tip = pi * N * D constant.
        </div>
      </section>
    </main>

    <footer>
      Prototype only. Verify values and units before use in design or operations.
    </footer>

    <div class="tutorial-overlay" id="tutorial-overlay" hidden>
      <div class="tutorial-card" role="dialog" aria-modal="true" aria-live="polite">
        <div class="tutorial-step" id="tutorial-step">Step 1 of 1</div>
        <div class="tutorial-text" id="tutorial-text"></div>
        <div class="tutorial-actions">
          <button class="tutorial-button" type="button" id="tutorial-back">Back</button>
          <button class="tutorial-button primary" type="button" id="tutorial-next">Next</button>
          <button class="tutorial-button" type="button" id="tutorial-close">Exit</button>
        </div>
      </div>
    </div>

    <datalist id="viscosity-list">
      <option value="Acetic acid"></option>
      <option value="Acetone"></option>
      <option value="Alcohol, ethyl (ethanol)"></option>
      <option value="Alcohol, methyl (methanol)"></option>
      <option value="Alcohol, propyl"></option>
      <option value="Benzene"></option>
      <option value="Bromine"></option>
      <option value="Carbon Disulfide"></option>
      <option value="Carbon Tetrachloride"></option>
      <option value="Castor Oil"></option>
      <option value="Chloroform"></option>
      <option value="Decane"></option>
      <option value="Dodecane"></option>
      <option value="Ether"></option>
      <option value="Ethylene Glycol"></option>
      <option value="Trichlorofluoromethane refrigerant R-11"></option>
      <option value="Glycerine"></option>
      <option value="Heptane"></option>
      <option value="Hexane"></option>
      <option value="Kerosene"></option>
      <option value="Linseed Oil"></option>
      <option value="Octane"></option>
      <option value="Phenol"></option>
      <option value="Propane"></option>
      <option value="Propylene"></option>
      <option value="Propylene glycol"></option>
      <option value="Toluene"></option>
      <option value="Turpentine"></option>
      <option value="Water, Fresh"></option>
    </datalist>

    <script>
      const tutorialSteps = [
        {
          selector: "#keep-pv h2",
          title: "Keep P/V constant",
          text:
            "Use this when matching energy input per volume matters (mixing time, solids suspension). " +
            "It scales power to keep P/V constant between lab and plant.",
        },
        {
          selectors: ["#pv-rho", "#pv-mu", "#pv-np-lab", "#pv-d-lab", "#pv-rpm-lab", "#pv-v-lab"],
          title: "Lab inputs (P/V)",
          text:
            "Rho = density, mu = viscosity (sets Reynolds regime). Np is the lab impeller power number. " +
            "Enter lab impeller diameter, lab rpm, and lab volume to anchor lab power and P/V. " +
            "Need Np or impeller help? Use the Impeller & Np guide link in the header.",
        },
        {
          selectors: ["#pv-d-plant", "#pv-v-plant", "#pv-np-plant"],
          title: "Plant inputs (P/V)",
          text:
            "Enter plant impeller diameter, plant volume, and plant Np (if geometry differs).",
        },
        {
          selector: "#keep-pv .results",
          title: "P/V results",
          text:
            "Outputs include power, P/V, rpm, tip speed, torque, and Reynolds regime for lab and plant.",
        },
        {
          selector: "#keep-tip h2",
          title: "Keep tip speed constant",
          text:
            "Use this when shear or gas dispersion is the key constraint. It keeps tip speed constant.",
        },
        {
          selectors: ["#tip-rho", "#tip-mu", "#tip-d-lab", "#tip-rpm-lab"],
          title: "Lab inputs (tip speed)",
          text:
            "Rho and mu set Reynolds regime. Lab impeller diameter and rpm define the target tip speed.",
        },
        {
          selectors: ["#tip-d-plant", "#tip-v-plant", "#tip-np-plant"],
          title: "Plant inputs (tip speed)",
          text:
            "Plant diameter sets the required rpm to match tip speed. Np and volume drive power and P/V.",
        },
        {
          selector: "#keep-tip .results",
          title: "Tip speed results",
          text:
            "Outputs include plant rpm, power, P/V, torque, and Reynolds regime.",
        },
      ];

      function toNumber(value) {
        const number = Number(value);
        return Number.isFinite(number) ? number : 0;
      }

      const viscosityMap = new Map([
        ["acetic acid", 0.001155],
        ["acetone", 0.000316],
        ["alcohol, ethyl (ethanol)", 0.001095],
        ["alcohol, methyl (methanol)", 0.00056],
        ["alcohol, propyl", 0.00192],
        ["benzene", 0.000601],
        ["bromine", 0.00095],
        ["carbon disulfide", 0.00036],
        ["carbon tetrachloride", 0.00091],
        ["castor oil", 0.65],
        ["chloroform", 0.00053],
        ["decane", 0.000859],
        ["dodecane", 0.00134],
        ["ether", 0.000223],
        ["ethylene glycol", 0.0162],
        ["trichlorofluoromethane refrigerant r-11", 0.00042],
        ["glycerine", 0.95],
        ["heptane", 0.000376],
        ["hexane", 0.000297],
        ["kerosene", 0.00164],
        ["linseed oil", 0.0331],
        ["octane", 0.00051],
        ["phenol", 0.008],
        ["propane", 0.00011],
        ["propylene", 0.00009],
        ["propylene glycol", 0.042],
        ["toluene", 0.00055],
        ["turpentine", 0.001375],
        ["water, fresh", 0.00089],
      ]);

      function normalizeName(value) {
        return String(value || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function parseMu(value) {
        const trimmed = String(value || "").trim();
        if (!trimmed) {
          return 0;
        }
        const numeric = Number(trimmed);
        if (Number.isFinite(numeric)) {
          return numeric;
        }
        const key = normalizeName(trimmed);
        if (viscosityMap.has(key)) {
          return viscosityMap.get(key);
        }
        return 0;
      }

      function enforceNonNegative(input) {
        if (input.type !== "number") {
          return;
        }
        const value = input.valueAsNumber;
        if (Number.isFinite(value) && value < 0) {
          input.value = "0";
        }
      }

      function updateMuHint(inputId, hintId) {
        const raw = document.getElementById(inputId).value;
        const key = normalizeName(raw);
        const hint = document.getElementById(hintId);
        if (viscosityMap.has(key)) {
          const mu = viscosityMap.get(key);
          hint.textContent = `Selected: ${raw} (${format(mu)} Pa*s)`;
        } else {
          hint.textContent = "";
        }
      }

      function regimeText(re) {
        if (re >= 1e4) {
          return "Turbulent (safe, Re>=10k)";
        }
        if (re >= 1e3) {
          return "Transition (1e3-1e4)";
        }
        return "Laminar (Re<1e3) - consider larger D or rpm";
      }

      function format(value) {
        if (!Number.isFinite(value)) {
          return "";
        }
        const abs = Math.abs(value);
        let output = "";
        if (abs >= 1000) {
          output = value.toFixed(2);
        } else if (abs >= 1) {
          output = value.toFixed(3);
        } else {
          output = value.toFixed(6);
        }
        return output.replace(/\.?0+$/, "");
      }

      const storagePrefix = "mixing-input:";

      function saveInputValue(input) {
        if (!input.id) {
          return;
        }
        sessionStorage.setItem(`${storagePrefix}${input.id}`, input.value);
      }

      function restoreInputs() {
        const inputs = document.querySelectorAll("input:not([readonly])");
        inputs.forEach((input) => {
          if (!input.id) {
            return;
          }
          const stored = sessionStorage.getItem(`${storagePrefix}${input.id}`);
          if (stored !== null) {
            input.value = stored;
          }
        });
      }

      function clearInputs() {
        const inputs = document.querySelectorAll("input:not([readonly])");
        inputs.forEach((input) => {
          input.value = "";
          if (input.id) {
            sessionStorage.removeItem(`${storagePrefix}${input.id}`);
          }
        });
        updateMuHint("pv-mu", "pv-mu-hint");
        updateMuHint("tip-mu", "tip-mu-hint");
        calcKeepPV();
        calcKeepTip();
      }

      function calcKeepPV() {
        const rho = toNumber(document.getElementById("pv-rho").value) * 1000;
        const mu = parseMu(document.getElementById("pv-mu").value);
        const npLab = toNumber(document.getElementById("pv-np-lab").value);
        const dLab = toNumber(document.getElementById("pv-d-lab").value) / 1000;
        const rpmLab = toNumber(document.getElementById("pv-rpm-lab").value);
        const vLab = toNumber(document.getElementById("pv-v-lab").value) / 1000;
        const dPlant = toNumber(document.getElementById("pv-d-plant").value) / 1000;
        const vPlant = toNumber(document.getElementById("pv-v-plant").value) / 1000;
        const npPlant = toNumber(document.getElementById("pv-np-plant").value);

        const nLab = rpmLab / 60;
        const uTipLab = Math.PI * nLab * dLab;
        const pLab = npLab * rho * Math.pow(nLab, 3) * Math.pow(dLab, 5);
        const pvLab = vLab > 0 ? pLab / vLab : 0;
        const reLab = mu > 0 ? (rho * nLab * Math.pow(dLab, 2)) / mu : 0;

        const pPlant = pvLab * vPlant;
        const nPlant =
          npPlant > 0 && rho > 0 && dPlant > 0
            ? Math.pow(pPlant / (npPlant * rho * Math.pow(dPlant, 5)), 1 / 3)
            : 0;
        const rpmPlant = nPlant * 60;
        const uTipPlant = Math.PI * nPlant * dPlant;
        const rePlant = mu > 0 ? (rho * nPlant * Math.pow(dPlant, 2)) / mu : 0;
        const torque = nPlant > 0 ? pPlant / (2 * Math.PI * nPlant) : 0;
        const pvPlant = vPlant > 0 ? pPlant / vPlant : 0;

        document.getElementById("pv-n-lab").value = format(nLab);
        document.getElementById("pv-ut-lab").value = format(uTipLab);
        document.getElementById("pv-p-lab").value = format(pLab);
        document.getElementById("pv-pv-lab").value = format(pvLab);
        document.getElementById("pv-re-lab").value = format(reLab);
        document.getElementById("pv-regime-lab").textContent = regimeText(reLab);
        document.getElementById("pv-p-plant").value = format(pPlant);
        document.getElementById("pv-n-plant").value = format(nPlant);
        document.getElementById("pv-rpm-plant").value = format(rpmPlant);
        document.getElementById("pv-ut-plant").value = format(uTipPlant);
        document.getElementById("pv-re-plant").value = format(rePlant);
        document.getElementById("pv-regime-plant").textContent = regimeText(rePlant);
        document.getElementById("pv-torque").value = format(torque);
        document.getElementById("pv-pv-plant").value = format(pvPlant);
      }

      function calcKeepTip() {
        const rho = toNumber(document.getElementById("tip-rho").value) * 1000;
        const mu = parseMu(document.getElementById("tip-mu").value);
        const npPlant = toNumber(document.getElementById("tip-np-plant").value);
        const dLab = toNumber(document.getElementById("tip-d-lab").value) / 1000;
        const rpmLab = toNumber(document.getElementById("tip-rpm-lab").value);
        const dPlant = toNumber(document.getElementById("tip-d-plant").value) / 1000;
        const vPlant = toNumber(document.getElementById("tip-v-plant").value) / 1000;

        const nLab = rpmLab / 60;
        const uTipTarget = Math.PI * nLab * dLab;
        const reLab = mu > 0 ? (rho * nLab * Math.pow(dLab, 2)) / mu : 0;

        const nPlant = dPlant > 0 ? uTipTarget / (Math.PI * dPlant) : 0;
        const rpmPlant = nPlant * 60;
        const pPlant = npPlant * rho * Math.pow(nPlant, 3) * Math.pow(dPlant, 5);
        const pvPlant = vPlant > 0 ? pPlant / vPlant : 0;
        const rePlant = mu > 0 ? (rho * nPlant * Math.pow(dPlant, 2)) / mu : 0;
        const torque = nPlant > 0 ? pPlant / (2 * Math.PI * nPlant) : 0;

        document.getElementById("tip-n-lab").value = format(nLab);
        document.getElementById("tip-ut-target").value = format(uTipTarget);
        document.getElementById("tip-re-lab").value = format(reLab);
        document.getElementById("tip-regime-lab").textContent = regimeText(reLab);
        document.getElementById("tip-n-plant").value = format(nPlant);
        document.getElementById("tip-rpm-plant").value = format(rpmPlant);
        document.getElementById("tip-p-plant").value = format(pPlant);
        document.getElementById("tip-pv-plant").value = format(pvPlant);
        document.getElementById("tip-re-plant").value = format(rePlant);
        document.getElementById("tip-regime-plant").textContent = regimeText(rePlant);
        document.getElementById("tip-torque").value = format(torque);
      }

      function wire() {
        const inputs = document.querySelectorAll("input:not([readonly])");
        restoreInputs();
        inputs.forEach((input) => {
          input.addEventListener("input", () => {
            enforceNonNegative(input);
            saveInputValue(input);
            updateMuHint("pv-mu", "pv-mu-hint");
            updateMuHint("tip-mu", "tip-mu-hint");
            calcKeepPV();
            calcKeepTip();
          });
        });
        const clearButton = document.getElementById("clear-values");
        if (clearButton) {
          clearButton.addEventListener("click", clearInputs);
        }
        updateMuHint("pv-mu", "pv-mu-hint");
        updateMuHint("tip-mu", "tip-mu-hint");
        calcKeepPV();
        calcKeepTip();
      }

      function cleanLabel(labelEl) {
        if (!labelEl) {
          return "";
        }
        const clone = labelEl.cloneNode(true);
        clone.querySelectorAll(".help,.pill").forEach((el) => el.remove());
        return clone.textContent.replace(/\s+/g, " ").trim();
      }

      function fieldLabel(id) {
        const el = document.getElementById(id);
        if (!el) {
          return id;
        }
        const field = el.closest(".field");
        const label = field ? field.querySelector("label") : null;
        return cleanLabel(label) || id;
      }

      function formatValue(id, opts = {}) {
        const el = document.getElementById(id);
        if (!el) {
          return "";
        }
        const raw = String(el.value || "").trim();
        if (!raw) {
          return "";
        }
        if (opts.kind === "mu") {
          const numeric = Number(raw);
          if (Number.isFinite(numeric)) {
            return format(numeric);
          }
          const mu = parseMu(raw);
          return mu > 0 ? `${raw} (${format(mu)} Pa*s)` : raw;
        }
        const numeric = Number(raw);
        if (Number.isFinite(numeric)) {
          return format(numeric);
        }
        return raw;
      }

      function buildCopyBlock(title, inputIds, outputIds, options = {}) {
        const lines = [title, ""];
        const inputLines = inputIds
          .map((id) => {
            const label = fieldLabel(id);
            const value = formatValue(id, options[id]);
            return value ? `${label} - ${value}` : "";
          })
          .filter(Boolean);
        const outputLines = outputIds
          .map((id) => {
            const label = fieldLabel(id);
            const value = formatValue(id);
            return value ? `${label} - ${value}` : "";
          })
          .filter(Boolean);

        if (inputLines.length) {
          lines.push("Inputs:");
          lines.push(...inputLines);
          lines.push("");
        }
        if (outputLines.length) {
          lines.push("Results:");
          lines.push(...outputLines);
        }
        return lines.join("\n").trim();
      }

      async function copyTextToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }

      function wireCopyButtons() {
        const copyPv = document.getElementById("copy-pv");
        const copyTip = document.getElementById("copy-tip");
        const pvInputIds = [
          "pv-rho",
          "pv-mu",
          "pv-np-lab",
          "pv-d-lab",
          "pv-rpm-lab",
          "pv-v-lab",
          "pv-d-plant",
          "pv-v-plant",
          "pv-np-plant",
        ];
        const pvOutputIds = [
          "pv-n-lab",
          "pv-ut-lab",
          "pv-p-lab",
          "pv-pv-lab",
          "pv-re-lab",
          "pv-p-plant",
          "pv-n-plant",
          "pv-rpm-plant",
          "pv-ut-plant",
          "pv-re-plant",
          "pv-torque",
          "pv-pv-plant",
        ];
        const tipInputIds = [
          "tip-rho",
          "tip-mu",
          "tip-d-lab",
          "tip-rpm-lab",
          "tip-d-plant",
          "tip-v-plant",
          "tip-np-plant",
        ];
        const tipOutputIds = [
          "tip-n-lab",
          "tip-ut-target",
          "tip-re-lab",
          "tip-n-plant",
          "tip-rpm-plant",
          "tip-p-plant",
          "tip-pv-plant",
          "tip-re-plant",
          "tip-torque",
        ];
        const pvOptions = { "pv-mu": { kind: "mu" } };
        const tipOptions = { "tip-mu": { kind: "mu" } };

        if (copyPv) {
          copyPv.addEventListener("click", async () => {
            const text = buildCopyBlock(
              "Keep P/V Constant",
              pvInputIds,
              pvOutputIds,
              pvOptions
            );
            await copyTextToClipboard(text);
            const original = copyPv.textContent;
            copyPv.textContent = "Copied";
            setTimeout(() => {
              copyPv.textContent = original;
            }, 1200);
          });
        }

        if (copyTip) {
          copyTip.addEventListener("click", async () => {
            const text = buildCopyBlock(
              "Keep Tip Speed Constant",
              tipInputIds,
              tipOutputIds,
              tipOptions
            );
            await copyTextToClipboard(text);
            const original = copyTip.textContent;
            copyTip.textContent = "Copied";
            setTimeout(() => {
              copyTip.textContent = original;
            }, 1200);
          });
        }
      }

      function initTutorial() {
        const overlay = document.getElementById("tutorial-overlay");
        const stepEl = document.getElementById("tutorial-step");
        const textEl = document.getElementById("tutorial-text");
        const backBtn = document.getElementById("tutorial-back");
        const nextBtn = document.getElementById("tutorial-next");
        const closeBtn = document.getElementById("tutorial-close");
        const startBtn = document.getElementById("start-tutorial");

        if (!overlay || !stepEl || !textEl || !backBtn || !nextBtn || !closeBtn || !startBtn) {
          return;
        }

        let index = 0;
        let currentTargets = [];

        function clearHighlight() {
          if (currentTargets.length) {
            currentTargets.forEach((target) => target.classList.remove("tutorial-target"));
            currentTargets = [];
          }
        }

        function showStep() {
          clearHighlight();
          let step = tutorialSteps[index];
          while (
            step &&
            !(
              (step.selector && document.querySelector(step.selector)) ||
              (step.selectors && step.selectors.some((sel) => document.querySelector(sel)))
            )
          ) {
            index += 1;
            step = tutorialSteps[index];
          }
          if (!step) {
            overlay.hidden = true;
            return;
          }
          const selectors = step.selectors || (step.selector ? [step.selector] : []);
          const targets = selectors
            .map((sel) => document.querySelector(sel))
            .filter((el) => el)
            .map((el) => el.closest(".field") || el);
          if (targets.length) {
            currentTargets = targets;
            targets.forEach((target) => target.classList.add("tutorial-target"));
            targets[0].scrollIntoView({ behavior: "smooth", block: "center" });
          }
          stepEl.textContent = `Step ${index + 1} of ${tutorialSteps.length}: ${step.title}`;
          textEl.textContent = step.text;
          backBtn.disabled = index === 0;
          nextBtn.textContent = index === tutorialSteps.length - 1 ? "Done" : "Next";
        }

        function openTutorial() {
          index = 0;
          overlay.hidden = false;
          overlay.removeAttribute("hidden");
          overlay.style.display = "flex";
          showStep();
        }

        function closeTutorial() {
          overlay.hidden = true;
          overlay.setAttribute("hidden", "");
          overlay.style.display = "none";
          clearHighlight();
        }

        startBtn.addEventListener("click", openTutorial);
        closeBtn.addEventListener("click", closeTutorial);
        backBtn.addEventListener("click", () => {
          if (index > 0) {
            index -= 1;
            showStep();
          }
        });
        nextBtn.addEventListener("click", () => {
          if (index < tutorialSteps.length - 1) {
            index += 1;
            showStep();
          } else {
            closeTutorial();
          }
        });
        overlay.addEventListener("click", (event) => {
          if (event.target === overlay) {
            closeTutorial();
          }
        });
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && !overlay.hidden) {
            closeTutorial();
          }
        });
      }

      window.addEventListener("DOMContentLoaded", wire);
      window.addEventListener("DOMContentLoaded", wireCopyButtons);
      window.addEventListener("DOMContentLoaded", initTutorial);
    </script>
  </body>
</html>
